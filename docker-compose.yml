version: '3.8'

services:
  # ============================================
  # Nginx Load Balancer
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - proxy-1
      - proxy-2
      - proxy-3
    networks:
      - cache-network
    restart: unless-stopped

  # ============================================
  # Proxy Services (3 instances)
  # ============================================
  proxy-1:
    build:
      context: .
      dockerfile: ./proxy/Dockerfile
    container_name: proxy-1
    environment:
      - SERVER_PORT=8080
      - CACHE_NODES=${CACHE_NODES}
      - CACHE_VIRTUAL_NODES=150
      - CACHE_TIMEOUT_MS=3000
      - CACHE_MAX_RETRIES=2
      - CACHE_POOL_SIZE=10
    ports:
      - "${PROXY_1_PORT:-8080}:8080"
    depends_on:
      - cache-master-1
      - cache-master-2
      - cache-master-3
    networks:
      - cache-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  proxy-2:
    build:
      context: .
      dockerfile: ./proxy/Dockerfile
    container_name: proxy-2
    environment:
      - SERVER_PORT=8080
      - CACHE_NODES=${CACHE_NODES}
      - CACHE_VIRTUAL_NODES=150
      - CACHE_TIMEOUT_MS=3000
      - CACHE_MAX_RETRIES=2
      - CACHE_POOL_SIZE=10
    ports:
      - "${PROXY_2_PORT:-8087}:8080"
    depends_on:
      - cache-master-1
      - cache-master-2
      - cache-master-3
    networks:
      - cache-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  proxy-3:
    build:
      context: .
      dockerfile: ./proxy/Dockerfile
    container_name: proxy-3
    environment:
      - SERVER_PORT=8080
      - CACHE_NODES=${CACHE_NODES}
      - CACHE_VIRTUAL_NODES=150
      - CACHE_TIMEOUT_MS=3000
      - CACHE_MAX_RETRIES=2
      - CACHE_POOL_SIZE=10
    ports:
      - "${PROXY_3_PORT:-8088}:8080"
    depends_on:
      - cache-master-1
      - cache-master-2
      - cache-master-3
    networks:
      - cache-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Cache Nodes - Masters (3 shards)
  # ============================================
  cache-master-1:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-master-1
    environment:
      - CACHE_NODE_ID=${MASTER_1_NODE_ID:-master-1}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${MASTER_1_CLIENT_PORT:-7000}
      - CACHE_NODE_REPLICATION_PORT=${MASTER_1_REPLICATION_PORT:-7100}
      - METRICS_PORT=9081
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=${MASTER_1_REPLICAS}
      - CACHE_NODE_ROLE=MASTER
      - CACHE_NODE_PRIORITY=0
    ports:
      - "${MASTER_1_CLIENT_PORT:-7000}:7000"
      - "${MASTER_1_REPLICATION_PORT:-7100}:7100"
      - "${MASTER_1_METRICS_PORT:-9081}:9081"
    volumes:
      - cache-master-1-data:/data
    networks:
      - cache-network
    restart: unless-stopped

  cache-master-2:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-master-2
    environment:
      - CACHE_NODE_ID=${MASTER_2_NODE_ID:-master-2}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${MASTER_2_CLIENT_PORT:-7001}
      - CACHE_NODE_REPLICATION_PORT=${MASTER_2_REPLICATION_PORT:-7101}
      - METRICS_PORT=9082
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=${MASTER_2_REPLICAS}
      - CACHE_NODE_ROLE=MASTER
      - CACHE_NODE_PRIORITY=0
    ports:
      - "${MASTER_2_CLIENT_PORT:-7001}:7001"
      - "${MASTER_2_REPLICATION_PORT:-7101}:7101"
      - "${MASTER_2_METRICS_PORT:-9082}:9082"
    volumes:
      - cache-master-2-data:/data
    networks:
      - cache-network
    restart: unless-stopped

  cache-master-3:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-master-3
    environment:
      - CACHE_NODE_ID=${MASTER_3_NODE_ID:-master-3}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${MASTER_3_CLIENT_PORT:-7002}
      - CACHE_NODE_REPLICATION_PORT=${MASTER_3_REPLICATION_PORT:-7102}
      - METRICS_PORT=9083
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=${MASTER_3_REPLICAS}
      - CACHE_NODE_ROLE=MASTER
      - CACHE_NODE_PRIORITY=0
    ports:
      - "${MASTER_3_CLIENT_PORT:-7002}:7002"
      - "${MASTER_3_REPLICATION_PORT:-7102}:7102"
      - "${MASTER_3_METRICS_PORT:-9083}:9083"
    volumes:
      - cache-master-3-data:/data
    networks:
      - cache-network
    restart: unless-stopped

  # ============================================
  # Cache Nodes - Replicas (3 replicas)
  # ============================================
  cache-replica-1:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-replica-1
    environment:
      - CACHE_NODE_ID=${REPLICA_1_NODE_ID:-replica-1}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${REPLICA_1_CLIENT_PORT:-7003}
      - CACHE_NODE_REPLICATION_PORT=${REPLICA_1_REPLICATION_PORT:-7103}
      - METRICS_PORT=9084
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=master-1:${REPLICA_1_MASTER_HOST:-cache-master-1}:7000:${REPLICA_1_MASTER_PORT:-7100}
      - CACHE_NODE_ROLE=REPLICA
      - CACHE_NODE_PRIORITY=1
    ports:
      - "${REPLICA_1_CLIENT_PORT:-7003}:7003"
      - "${REPLICA_1_REPLICATION_PORT:-7103}:7103"
      - "${REPLICA_1_METRICS_PORT:-9084}:9084"
    volumes:
      - cache-replica-1-data:/data
    depends_on:
      - cache-master-1
    networks:
      - cache-network
    restart: unless-stopped

  cache-replica-2:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-replica-2
    environment:
      - CACHE_NODE_ID=${REPLICA_2_NODE_ID:-replica-2}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${REPLICA_2_CLIENT_PORT:-7004}
      - CACHE_NODE_REPLICATION_PORT=${REPLICA_2_REPLICATION_PORT:-7104}
      - METRICS_PORT=9085
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=master-2:${REPLICA_2_MASTER_HOST:-cache-master-2}:7001:${REPLICA_2_MASTER_PORT:-7101}
      - CACHE_NODE_ROLE=REPLICA
      - CACHE_NODE_PRIORITY=1
    ports:
      - "${REPLICA_2_CLIENT_PORT:-7004}:7004"
      - "${REPLICA_2_REPLICATION_PORT:-7104}:7104"
      - "${REPLICA_2_METRICS_PORT:-9085}:9085"
    volumes:
      - cache-replica-2-data:/data
    depends_on:
      - cache-master-2
    networks:
      - cache-network
    restart: unless-stopped

  cache-replica-3:
    build:
      context: .
      dockerfile: ./cache-node/Dockerfile
    container_name: cache-replica-3
    environment:
      - CACHE_NODE_ID=${REPLICA_3_NODE_ID:-replica-3}
      - CACHE_NODE_HOST=0.0.0.0
      - CACHE_NODE_PORT=${REPLICA_3_CLIENT_PORT:-7005}
      - CACHE_NODE_REPLICATION_PORT=${REPLICA_3_REPLICATION_PORT:-7105}
      - METRICS_PORT=9086
      - CACHE_CLUSTER_ENABLED=true
      - CACHE_CLUSTER_NODES=master-3:${REPLICA_3_MASTER_HOST:-cache-master-3}:7002:${REPLICA_3_MASTER_PORT:-7102}
      - CACHE_NODE_ROLE=REPLICA
      - CACHE_NODE_PRIORITY=1
    ports:
      - "${REPLICA_3_CLIENT_PORT:-7005}:7005"
      - "${REPLICA_3_REPLICATION_PORT:-7105}:7105"
      - "${REPLICA_3_METRICS_PORT:-9086}:9086"
    volumes:
      - cache-replica-3-data:/data
    depends_on:
      - cache-master-3
    networks:
      - cache-network
    restart: unless-stopped

  # ============================================
  # Monitoring Stack
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - cache-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    volumes:
      - ./monitoring/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./monitoring/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./monitoring/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
    networks:
      - cache-network
    restart: unless-stopped

  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./monitoring/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - cache-network
    restart: unless-stopped

# ============================================
# Networks
# ============================================
networks:
  cache-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ============================================
# Volumes for data persistence
# ============================================
volumes:
  # Cache node data
  cache-master-1-data:
  cache-master-2-data:
  cache-master-3-data:
  cache-replica-1-data:
  cache-replica-2-data:
  cache-replica-3-data:

  # Monitoring data
  prometheus-data:
  grafana-data:
  loki-data:
